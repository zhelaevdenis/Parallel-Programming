Здесь лежит переработанная версия оригинального приложения.
Я ввёл в критическую секцию операцию снятия и начисления денег.
Таким образом задержка остаётся, но пока деньги не будут списаны, другие потоки занятые снятием не смогут обратиться к счёту и снять несуществующие деньги.
Таким образом баланс не уходит в минус.
